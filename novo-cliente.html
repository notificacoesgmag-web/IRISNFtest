async function enviarParaN8N(tipo) {
    // URLs CORRIGIDAS
    const urlConsulta = 'https://vissionlet.com/n8n/webhook-test/novo-cliente';
    const urlRegistro = 'https://vissionlet.com/n8n/webhook-test/registro-final-asaas';

    if (tipo === 'consultar') {
        const cnpj = document.getElementById('cnpj').value.replace(/\D/g, '');
        if(cnpj.length < 14) return alert('CNPJ inválido');
        toggleLoading(true, 'btnConsultar', 'Buscando...');

        try {
            const response = await fetch(urlConsulta, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ acao: 'consultar_cnpj', cnpj: cnpj })
            });
            const dados = await response.json();

            // Preenche os campos (com fallback para vazio se não encontrar)
            document.getElementById('razao_social').value = dados.nome || '';
            document.getElementById('logradouro').value = dados.logradouro || '';
            document.getElementById('numero').value = dados.numero || '';
            document.getElementById('bairro').value = dados.bairro || '';
            document.getElementById('cep').value = dados.cep || '';
            document.getElementById('cidade').value = dados.cidade || '';
            document.getElementById('uf').value = dados.estado || '';
            document.getElementById('email').value = dados.email || '';

            document.getElementById('passo1').classList.remove('active');
            document.getElementById('passo2').classList.add('active');
        } catch (err) { 
            alert('CNPJ não encontrado. Preencha manualmente.'); 
            document.getElementById('passo1').classList.remove('active');
            document.getElementById('passo2').classList.add('active');
        } finally { toggleLoading(false, 'btnConsultar', 'Buscar Dados'); }

    } else if (tipo === 'salvar') {
        toggleLoading(true, 'btnSalvar', 'Enviando para o Asaas...');
        
        const payload = {
            razao_social: document.getElementById('razao_social').value,
            logradouro: document.getElementById('logradouro').value,
            numero: document.getElementById('numero').value,
            bairro: document.getElementById('bairro').value,
            cep: document.getElementById('cep').value.replace(/\D/g, ''),
            cidade: document.getElementById('cidade').value,
            uf: document.getElementById('uf').value,
            email: document.getElementById('email').value,
            cnpj: document.getElementById('cnpj').value.replace(/\D/g, '')
        };

        try {
            // Usamos await aqui para garantir que o envio termine antes de mudar de página
            await fetch(urlRegistro, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            alert('✅ Registro enviado com sucesso!');
            window.open('sucesso.html', '_blank'); 
            window.location.href = 'index.html'; 

        } catch (err) { alert('Erro ao registrar.'); }
        finally { toggleLoading(false, 'btnSalvar', 'Confirmar e Registrar'); }
    }
}